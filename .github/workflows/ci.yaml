# =============================================================================
# Single-Cell Analysis Blueprint CI
# =============================================================================
#
# Required Secrets:
#   - NGC_API_KEY          : NVIDIA NGC API Key for container registry access
#   - SMTP_USERNAME        : Gmail address for sending notification emails
#   - SMTP_PASSWORD        : Gmail app-specific password for SMTP
#
# pytest markers:
#   - single_cell and notebook
#
# Note: This project has 7 analysis notebooks executed via matrix (serial)
#       No UI tests - only notebook tests
#
# =============================================================================

name: Single-Cell Analysis Blueprint CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TEST_IMAGE: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest
  QA_TESTER_REPO: https://github.com/bp-cicd-org/qa-tester.git
  DOCKER_IMG_NAME: nvcr.io/nvidia/rapidsai/notebooks
  DOCKER_IMG_TAG: "25.06-cuda12.8-py3.12"

jobs:
  # ============================================
  # PREFLIGHT: Check all prerequisites
  # ============================================
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      preflight_passed: ${{ steps.preflight.outputs.passed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Preflight Checks
        id: preflight
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "========================================"
          echo "  PREFLIGHT CHECKS"
          echo "========================================"
          echo ""
          
          FAILED=0
          
          # Check 1: NGC API Key
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 1/4] NGC API Key                      │"
          echo "└──────────────────────────────────────────────┘"
          if [ -z "${NGC_API_KEY}" ]; then
            echo "✗ ERROR: NGC_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NGC_API_KEY is set"
          fi
          echo ""
          
          # Check 2: Test Image can be pulled
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 2/4] Test Image                       │"
          echo "└──────────────────────────────────────────────┘"
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          if docker pull ${{ env.TEST_IMAGE }}; then
            echo "✓ Test image pulled successfully"
          else
            echo "✗ ERROR: Cannot pull test image"
            FAILED=1
          fi
          echo ""
          
          # Check 3: Required notebooks exist
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 3/4] Required Notebooks               │"
          echo "└──────────────────────────────────────────────┘"
          NOTEBOOKS=(
            "notebooks/01_scRNA_analysis_preprocessing.ipynb"
            "notebooks/02_scRNA_analysis_extended.ipynb"
            "notebooks/03_scRNA_analysis_with_pearson_residuals.ipynb"
            "notebooks/04_scRNA_analysis_dask_out_of_core.ipynb"
            "notebooks/05_scRNA_analysis_multi_GPU.ipynb"
            "notebooks/06_scRNA_analysis_90k_brain_example.ipynb"
            "notebooks/07_scRNA_analysis_1.3M_brain_example.ipynb"
          )
          for nb in "${NOTEBOOKS[@]}"; do
            if [ -f "$nb" ]; then
              echo "✓ $nb exists"
            else
              echo "✗ ERROR: $nb not found"
              FAILED=1
            fi
          done
          echo ""
          
          # Check 4: Docker Compose files
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 4/4] Docker Compose Files             │"
          echo "└──────────────────────────────────────────────┘"
          if [ -f "docker/brev/docker-compose-nb-2504.yaml" ]; then
            echo "✓ docker/brev/docker-compose-nb-2504.yaml exists"
          else
            echo "⚠ WARNING: docker-compose file not found"
          fi
          echo ""
          
          # Final result
          echo "========================================"
          if [ $FAILED -eq 0 ]; then
            echo "✓ ALL PREFLIGHT CHECKS PASSED"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ PREFLIGHT CHECKS FAILED"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "========================================"

  # ============================================
  # NOTEBOOK EXECUTION: Matrix-based serial execution
  # ============================================
  notebook-execution:
    name: Notebook - ${{ matrix.notebook }}
    needs: preflight
    if: ${{ needs.preflight.outputs.preflight_passed == 'true' }}
    runs-on: arc-runner-set-oke-org-poc-4-gpu
    # runs-on: arc-runners-org-nvidia-ai-bp-4-gpu
    timeout-minutes: 60
    
    strategy:
      matrix:
        notebook:
          - "01_scRNA_analysis_preprocessing.ipynb"
          - "02_scRNA_analysis_extended.ipynb"
          - "03_scRNA_analysis_with_pearson_residuals.ipynb"
          - "04_scRNA_analysis_dask_out_of_core.ipynb"
          - "05_scRNA_analysis_multi_GPU.ipynb"
          - "06_scRNA_analysis_90k_brain_example.ipynb"
          - "07_scRNA_analysis_1.3M_brain_example.ipynb"
      max-parallel: 1  # Serial execution
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================
      # PHASE 1: Environment Setup
      # ==========================================
      - name: Setup Environment
        run: |
          echo "========================================"
          echo "  SINGLE-CELL ANALYSIS - ${{ matrix.notebook }}"
          echo "========================================"
          
          # System info
          echo "Runner: $(hostname)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "Docker: $(docker --version)"
          echo ""
          
          # GPU info
          echo "GPU Information:"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader || echo "nvidia-smi not available"
          echo ""

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Pull Test Image
        run: |
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          docker pull ${{ env.TEST_IMAGE }}
          echo "✓ Test image pulled successfully"

      - name: Pull RAPIDS Notebook Image
        run: |
          echo "Pulling RAPIDS image: ${{ env.DOCKER_IMG_NAME }}:${{ env.DOCKER_IMG_TAG }}"
          docker pull ${{ env.DOCKER_IMG_NAME }}:${{ env.DOCKER_IMG_TAG }}
          echo "✓ RAPIDS image pulled successfully"

      # ==========================================
      # PHASE 2: Setup Notebook Runner
      # ==========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Notebook Runner
        run: |
          echo "Cloning qa-tester repository..."
          git clone --depth 1 ${{ env.QA_TESTER_REPO }} _qa_tester
          cp _qa_tester/utils/notebook_runner/notebook_runner_nbclient.py .
          rm -rf _qa_tester
          chmod +x notebook_runner_nbclient.py
          echo "✓ notebook_runner_nbclient.py ready"

      - name: Install Notebook Dependencies
        run: |
          pip install --upgrade pip
          pip install ipykernel nbclient nbformat jupyter nbconvert papermill
          python -m ipykernel install --user --name python3 --display-name "Python 3"
          echo "✓ Notebook dependencies installed"

      # ==========================================
      # PHASE 3: Start RAPIDS Container
      # ==========================================
      - name: Start RAPIDS Container
        run: |
          echo "Starting RAPIDS container for notebook execution..."
          
          # Create docker-compose override for environment
          cat > docker-compose.override.yml <<EOF
          version: '3.8'
          services:
            backend:
              image: ${{ env.DOCKER_IMG_NAME }}:${{ env.DOCKER_IMG_TAG }}
              volumes:
                - ${{ github.workspace }}:/notebooks
              working_dir: /notebooks
              environment:
                UCX_TLS: tcp
                UCX_MEMTYPE_CACHE: n
                DASK_SCHEDULER: synchronous
                CUDA_LAUNCH_BLOCKING: '1'
              deploy:
                resources:
                  reservations:
                    devices:
                      - driver: nvidia
                        count: all
                        capabilities: [gpu]
              command: sleep infinity
          EOF
          
          docker compose -f docker-compose.override.yml up -d
          
          # Wait for container to be ready
          sleep 10
          docker ps -a
          echo "✓ RAPIDS container started"

      # ==========================================
      # PHASE 4: Execute Notebook
      # ==========================================
      - name: Execute Notebook - ${{ matrix.notebook }}
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "========================================"
          echo "  EXECUTING NOTEBOOK: ${{ matrix.notebook }}"
          echo "========================================"
          
          NOTEBOOK_BASENAME=$(basename "${{ matrix.notebook }}" .ipynb)
          
          mkdir -p notebook_output
          
          # Execute notebook inside RAPIDS container
          docker compose -f docker-compose.override.yml exec -T backend bash -c "
            cd /notebooks
            pip install ipykernel nbclient nbformat jupyter nbconvert papermill
            python -m ipykernel install --user --name python3 --display-name 'Python 3'
            
            # Install project requirements
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
            
            # Execute notebook with papermill
            python -m papermill notebooks/${{ matrix.notebook }} notebook_output/result_${{ matrix.notebook }} \
              --log-output \
              --progress-bar \
              --kernel python3 || exit 1
            
            # Convert to HTML
            jupyter nbconvert --to html notebook_output/result_${{ matrix.notebook }} \
              --output ${NOTEBOOK_BASENAME}.html \
              --output-dir notebook_output/
          "
          
          echo ""
          echo "✓ Notebook execution completed"
          echo "Generated files:"
          ls -la notebook_output/

      # ==========================================
      # PHASE 5: Run pytest Notebook Tests
      # ==========================================
      - name: Run Notebook Tests
        id: pytest
        continue-on-error: true
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: single_cell notebook"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          NOTEBOOK_BASENAME=$(basename "${{ matrix.notebook }}" .ipynb)
          REPORT_FILE="single_cell_${NOTEBOOK_BASENAME}_${COMMIT_SHA}_test_report.html"
          
          mkdir -p test_reports
          mkdir -p notebook_output/single_cell_analysis
          
          # Copy notebook HTML to expected location for tests
          if [ -f "notebook_output/${NOTEBOOK_BASENAME}.html" ]; then
            cp "notebook_output/${NOTEBOOK_BASENAME}.html" "notebook_output/single_cell_analysis/"
            echo "✓ Notebook HTML prepared for testing"
          fi
          
          # Run pytest with test image
          docker run --rm \
            --network host \
            -v "$(pwd)/notebook_output:/app/input" \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "single_cell and notebook" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE} \
            || echo "pytest_exit_code=$?" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: single-cell-test-report-${{ matrix.notebook }}
          path: test_reports/
          retention-days: 30

      - name: Upload Notebook HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: single-cell-notebook-html-${{ matrix.notebook }}
          path: notebook_output/*.html
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping containers..."
          docker compose -f docker-compose.override.yml down 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true
          echo "✓ Cleanup completed"

  # ============================================
  # SUMMARY: Generate final report
  # ============================================
  summary:
    name: Generate Summary
    needs: [preflight, notebook-execution]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Single-Cell Analysis Blueprint CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notebook Execution | ${{ needs.notebook-execution.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **pytest markers**: \`single_cell and notebook\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution mode**: Serial (max-parallel: 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Notebooks Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Dynamically list executed notebooks from artifacts
          if [ -d "artifacts" ]; then
            NOTEBOOK_COUNT=0
            echo "| Notebook | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
            for dir in artifacts/single-cell-notebook-html-*/; do
              if [ -d "$dir" ]; then
                NOTEBOOK_NAME=$(basename "$dir" | sed 's/single-cell-notebook-html-//')
                echo "| ${NOTEBOOK_NAME} | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
                NOTEBOOK_COUNT=$((NOTEBOOK_COUNT + 1))
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total notebooks executed**: ${NOTEBOOK_COUNT}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No notebook artifacts found." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports and notebook HTML outputs are available in the Artifacts section." >> $GITHUB_STEP_SUMMARY
          
          if [ -d "artifacts" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find artifacts -type f -name "*.html" 2>/dev/null || echo "No HTML files found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set Result Output
        id: set_result
        if: always()
        run: |
          if [ "${{ needs.preflight.result }}" == "success" ] && [ "${{ needs.notebook-execution.result }}" == "success" ]; then
            echo "RESULT=PASS" >> $GITHUB_OUTPUT
          else
            echo "RESULT=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@6e71c855c9a091d80a519621b9fd3e8d252ca40c
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI Result: Single-Cell Analysis Blueprint - ${{ steps.set_result.outputs.RESULT }}"
          to: Github-Action-Blueprint-QA@nvidia.com
          from: github-workflow-notification@gmail.com
          html_body: |
            <h2>Single-Cell Analysis Blueprint CI Notification</h2>
            
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>Result:</strong> <span style="color: ${{ steps.set_result.outputs.RESULT == 'PASS' && 'green' || 'red' }}; font-weight: bold;">${{ steps.set_result.outputs.RESULT }}</span></p>
            
            <h3>Job Results</h3>
            <table border="1" cellpadding="5" cellspacing="0">
              <tr><th>Job</th><th>Status</th></tr>
              <tr><td>Preflight</td><td>${{ needs.preflight.result }}</td></tr>
              <tr><td>Notebook Execution</td><td>${{ needs.notebook-execution.result }}</td></tr>
            </table>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></p>
